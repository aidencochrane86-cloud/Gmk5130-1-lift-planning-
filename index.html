function calculate() {
  const load = +loadInput.value;
  const rigging = riggingInput.value ? +riggingInput.value : 0;
  const totalLoad = load + rigging;
  const radius = +radiusInput.value;

  if (!load || !radius) return;

  pivot.style.visibility =
  boomLine.style.visibility =
  radiusLine.style.visibility =
  tipHeightLine.style.visibility = "visible";

  const obsR = +obsRadiusInput.value;
  const obsH = +obsHeightInput.value;
  const margin = +marginInput.value || 0;
  const obstructionActive = obsR && obsH;

  let candidates = [];

  DATA.forEach(r => {
    if (r.radius < radius) return;
    if (r.capacity < totalLoad) return;

    const tipHeight =
      Math.sqrt(Math.max(0, r.boom**2 - radius**2));

    // ✅ Step A: DO NOT reject based on clearance
    candidates.push({
      boom: r.boom,
      capacity: r.capacity,
      config: r.config,
      util: totalLoad / r.capacity * 100,
      tipHeight
    });
  });

  if (!candidates.length) {
    result.innerHTML = `<p class="fail">Lift not possible</p>`;
    obstructionRect.style.visibility =
    clearanceLine.style.visibility = "hidden";
    return;
  }

  candidates.sort((a,b)=>a.util-b.util);
  const best = candidates[0];

  const boomX = pivotX + radius * SVG_SCALE;
  const boomY = pivotY - best.tipHeight * SVG_SCALE;

  pivot.setAttribute("cy", pivotY);
  boomLine.setAttribute("x1", pivotX);
  boomLine.setAttribute("y1", pivotY);
  boomLine.setAttribute("x2", boomX);
  boomLine.setAttribute("y2", boomY);

  radiusLine.setAttribute("x1", pivotX);
  radiusLine.setAttribute("y1", pivotY);
  radiusLine.setAttribute("x2", boomX);
  radiusLine.setAttribute("y2", pivotY);

  tipHeightLine.setAttribute("x1", boomX);
  tipHeightLine.setAttribute("y1", boomY);
  tipHeightLine.setAttribute("x2", boomX);
  tipHeightLine.setAttribute("y2", pivotY);

  if (obstructionActive) {
    const obsX = pivotX + obsR * SVG_SCALE;
    const obsTopY = groundY - obsH * SVG_SCALE;

    obstructionRect.style.visibility =
    clearanceLine.style.visibility = "visible";

    obstructionRect.setAttribute("x", obsX - 15);
    obstructionRect.setAttribute("y", obsTopY);
    obstructionRect.setAttribute("height", obsH * SVG_SCALE);

    const boomHeightAtObs =
      best.tipHeight * (obsR / radius);

    clearanceLine.setAttribute("x1", obsX - 15);
    clearanceLine.setAttribute("x2", obsX - 15);
    clearanceLine.setAttribute("y1", obsTopY);
    clearanceLine.setAttribute(
      "y2",
      pivotY - boomHeightAtObs * SVG_SCALE
    );
  } else {
    obstructionRect.style.visibility =
    clearanceLine.style.visibility = "hidden";
  }

  result.innerHTML = `
    <p><b>Total weight:</b> ${totalLoad.toFixed(2)} t</p>
    <p><b>Outriggers:</b> ${META.outriggers || "—"}</p>
    <p><b>Ballast:</b> ${ballast.selectedOptions[0].text}</p>
    <p><b>Configuration:</b> ${best.config}</p>
    <p><b>SLI:</b> <b>${META.sli || "—"}</b></p>
    <p><b>Boom length:</b> ${best.boom} m</p>
    <p><b>Tip height:</b> ${best.tipHeight.toFixed(2)} m</p>
    <p><b>Working radius:</b> ${radius.toFixed(1)} m</p>
    <p><b>Utilisation:</b>
      <span class="${utilClass(best.util)}">${best.util.toFixed(1)}%</span>
    </p>
  `;
}

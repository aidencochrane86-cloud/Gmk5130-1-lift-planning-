<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lift Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:16px; }
.card { background:#fff; padding:16px; margin-bottom:16px; border-radius:8px; }
label { display:block; margin-top:10px; font-weight:bold; }
input[type="number"], select { width:100%; padding:6px; margin-top:4px; }
.meta { font-size:0.9em; background:#eef6ff; padding:8px; border-radius:6px; }
.badge { display:inline-block; padding:4px 8px; color:#fff; border-radius:12px; font-size:0.8em; }
.badge.optimised { background:#6a1b9a; }
.badge.boom { background:#555; }

.util-green { color:#1a7f37; font-weight:bold; }
.util-amber { color:#b26a00; font-weight:bold; }
.util-red { color:#b42318; font-weight:bold; }

.risk-low { color:#1a7f37; font-weight:bold; }
.risk-mid { color:#b26a00; font-weight:bold; }
.risk-high { color:#b42318; font-weight:bold; }
</style>
</head>

<body>

<div class="card meta">
  <strong>Crane:</strong> GMK5130-1<br>
  <span id="metaBallast"><strong>Ballast:</strong> —</span><br>
  <span id="modeBadge" class="badge optimised">Mode: AP Mode</span>
</div>

<div class="card">
<h2>Inputs</h2>

<label><input type="radio" name="mode" value="ap" checked> AP Mode</label>
<label><input type="radio" name="mode" value="boom"> Boom-specific</label>

<label>Ballast</label>
<select id="ballast">
  <option value="40_1t">40.1t</option>
  <option value="23_5t">23.5t</option>
</select>

<label>Load (t)</label>
<input id="load" type="number">

<label>Working Radius (m)</label>
<input id="radius" type="number">

<label>
  <input type="checkbox" id="radiusLocked">
  Radius is fixed
</label>

<label>Obstruction Radius (m)</label>
<input id="obsRadius" type="number">

<label>Obstruction Height (m)</label>
<input id="obsHeight" type="number">

<label>Clearance Margin (m)</label>
<input id="margin" type="number">
</div>

<div class="card">
<h2>Result</h2>
<div id="result">Enter inputs.</div>
</div>

<script>
const STANDARD_LIMIT = 85;
const ABSOLUTE_LIMIT = 90;
const BOOM_FOOT_HEIGHT = 2.0;

let DATA = [];
const ballast = document.getElementById("ballast");
const loadInput = document.getElementById("load");
const radiusInput = document.getElementById("radius");
const obsRadiusInput = document.getElementById("obsRadius");
const obsHeightInput = document.getElementById("obsHeight");
const marginInput = document.getElementById("margin");
const radiusLockedInput = document.getElementById("radiusLocked");
const result = document.getElementById("result");
const modeBadge = document.getElementById("modeBadge");
const metaBallast = document.getElementById("metaBallast");

function utilClass(u) {
  if (u >= ABSOLUTE_LIMIT) return "util-red";
  if (u > STANDARD_LIMIT) return "util-amber";
  return "util-green";
}

function riskLabel(u) {
  if (u >= ABSOLUTE_LIMIT) return `<span class="risk-high">Risk: NOT PERMITTED</span>`;
  if (u > STANDARD_LIMIT) return `<span class="risk-high">Risk: HIGH</span>`;
  if (u > 75) return `<span class="risk-mid">Risk: MODERATE</span>`;
  return `<span class="risk-low">Risk: LOW</span>`;
}

function loadData(key) {
  fetch(`loadchart_${key}.json`)
    .then(r => r.json())
    .then(d => {
      DATA = d.charts;
      metaBallast.innerHTML = `<strong>Ballast:</strong> ${ballast.selectedOptions[0].text}`;
      calculate();
    });
}

function calculate() {
  const mode = document.querySelector('input[name="mode"]:checked').value;
  modeBadge.textContent = mode === "boom" ? "Mode: Boom-specific" : "Mode: AP Mode";
  modeBadge.className = "badge " + (mode === "boom" ? "boom" : "optimised");

  if (mode === "boom") {
    result.innerHTML = "Boom-specific mode active.";
    return;
  }

  const load = +loadInput.value;
  const radius = +radiusInput.value;
  const obsR = +obsRadiusInput.value;
  const obsH = +obsHeightInput.value;
  const margin = +marginInput.value || 0;
  const radiusLocked = radiusLockedInput.checked;

  if (!load || !radius || !obsR || !obsH) {
    result.innerHTML = "Enter all required inputs.";
    return;
  }

  let candidates = [];

  DATA.forEach(r => {
    if (radiusLocked) {
      if (r.radius !== radius) return;
    } else {
      if (r.radius < radius) return;
    }

    if (r.capacity < load) return;

    const horiz = r.boom * r.boom - radius * radius;
    if (horiz <= 0) return;

    const tip = BOOM_FOOT_HEIGHT + Math.sqrt(horiz);
    const reqH = (obsH * radius / obsR) + margin;
    if (tip < reqH) return;

    const util = load / r.capacity * 100;
    candidates.push({ ...r, util });
  });

  if (!candidates.length) {
    result.innerHTML = "❌ Rejected: Rated capacity exceeded at this radius.";
    return;
  }

  let best;
  if (radiusLocked) {
    best = candidates.sort((a,b)=>a.capacity - b.capacity)[0];
  } else {
    best = candidates.sort((a,b)=>a.util - b.util)[0];
  }

  let html = `
    <p><b>Utilisation:</b>
      <span class="${utilClass(best.util)}">${best.util.toFixed(1)}%</span>
    </p>
    <p>${riskLabel(best.util)}</p>
  `;

  if (best.util >= ABSOLUTE_LIMIT) {
    html += `<p>❌ Rejected: Utilisation exceeds absolute system limit.</p>`;
    result.innerHTML = html;
    return;
  }

  if (best.util > STANDARD_LIMIT) {
    html += `
      <p>❌ Rejected: Utilisation exceeds standard planning limit.</p>
      <label>
        <input type="checkbox" id="utilOverride">
        Allow lift below 90% utilisation (engineering approval)
      </label>
    `;
    result.innerHTML = html;

    setTimeout(() => {
      const chk = document.getElementById("utilOverride");
      chk.addEventListener("change", () => {
        if (chk.checked) {
          result.innerHTML = html + `
            <hr>
            <p>✅ Lift allowed under elevated utilisation policy</p>
            <p><b>Configuration:</b> ${best.config || "—"}</p>
            <p><b>Boom:</b> ${best.boom} m</p>
            <p><b>Utilisation:</b> ${best.util.toFixed(1)}%</p>
            <p>${riskLabel(best.util)}</p>
          `;
        }
      });
    }, 0);
    return;
  }

  html += `
    <p>✅ Lift permitted within standard limits</p>
    <p><b>Configuration:</b> ${best.config || "—"}</p>
    <p><b>Boom:</b> ${best.boom} m</p>
  `;

  result.innerHTML = html;
}

[
  loadInput, radiusInput,
  obsRadiusInput, obsHeightInput,
  marginInput, radiusLockedInput
].forEach(e => e.addEventListener("input", calculate));

ballast.addEventListener("change", () => loadData(ballast.value));
document.querySelectorAll('input[name="mode"]').forEach(r => r.addEventListener("change", calculate));

loadData(ballast.value);
</script>

</body>
</html>

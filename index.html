<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lift Planner – Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f6f8;
  padding:16px;
}
.card {
  background:#fff;
  padding:16px;
  margin-bottom:16px;
  border-radius:8px;
}
label {
  display:block;
  margin-top:10px;
  font-weight:bold;
}
input[type="number"], select {
  width:100%;
  padding:6px;
  margin-top:4px;
}
input::placeholder {
  color:#999;
  font-style:italic;
}
.meta {
  font-size:0.9em;
  background:#eef6ff;
  padding:8px;
  border-radius:6px;
}
.badge {
  display:inline-block;
  margin-top:6px;
  padding:4px 8px;
  color:#fff;
  border-radius:12px;
  font-size:0.8em;
}
.badge.basic { background:#0066cc; }

.fail { color:#b42318; font-weight:bold; }
.advice { color:#555; font-size:0.9em; }

.util-green { color:#1a7f37; font-weight:bold; }
.util-amber { color:#b26a00; font-weight:bold; }
.util-red   { color:#b42318; font-weight:bold; }
</style>
</head>

<body>

<div class="card meta">
  <strong>Crane:</strong> GMK5130-1<br>
  <strong>Slew:</strong> 360°<br>
  <span id="metaBallast"><strong>Ballast:</strong> —</span><br>
  <span class="badge basic">Mode: Basic Mode</span>
</div>

<div class="card">
<h2>Inputs</h2>

<label>Ballast</label>
<select id="ballast">
  <option value="40_1t">40.1t</option>
  <option value="23_5t">23.5t</option>
  <option value="6t">6t</option>
</select>

<label>Load (t)</label>
<input id="load" type="number">

<label>Block &amp; rigging (t)</label>
<input id="rigging" type="number" placeholder="optional">

<label>Working Radius (m)</label>
<input id="radius" type="number">

<!-- ✅ OBSTRUCTION INPUTS (VISIBLE) -->
<label>Obstruction Radius (m)</label>
<input id="obsRadius" type="number" placeholder="optional">

<label>Obstruction Height (m)</label>
<input id="obsHeight" type="number" placeholder="optional">

<label>Clearance Margin (m)</label>
<input id="margin" type="number" placeholder="optional">
</div>

<div class="card">
<h2>Result</h2>
<div id="result">Select inputs.</div>
</div>

<script>
const BOOM_FOOT_HEIGHT = 2.0;
let DATA = [], META = {};

const ballast = document.getElementById("ballast");
const loadInput = document.getElementById("load");
const riggingInput = document.getElementById("rigging");
const radiusInput = document.getElementById("radius");
const obsRadiusInput = document.getElementById("obsRadius");
const obsHeightInput = document.getElementById("obsHeight");
const marginInput = document.getElementById("margin");
const result = document.getElementById("result");
const metaBallast = document.getElementById("metaBallast");

function utilClass(u) {
  if (u >= 90) return "util-red";
  if (u > 85) return "util-amber";
  return "util-green";
}

function loadData(key) {
  fetch(`loadchart_${key}.json`)
    .then(r => r.json())
    .then(d => {
      DATA = d.charts;
      META = d.meta || {};
      let h = `<strong>Ballast:</strong> ${ballast.selectedOptions[0].text}`;
      if (META.outriggers) h += `<br><strong>Outriggers:</strong> ${META.outriggers}`;
      if (META.sli) h += `<br><strong>SLI:</strong> ${META.sli}`;
      metaBallast.innerHTML = h;
      calculate();
    });
}

function calculate() {
  const load = +loadInput.value;
  const rigging = riggingInput.value ? +riggingInput.value : 0;
  const totalLoad = load + rigging;
  const reqRadius = +radiusInput.value;

  if (!load || !reqRadius) {
    result.innerHTML = "Enter load and radius.";
    return;
  }

  const usableRadii = [...new Set(
    DATA.map(r => r.radius).filter(r => r >= reqRadius)
  )];

  if (!usableRadii.length) {
    result.innerHTML = `<p class="fail">No valid chart radius available.</p>`;
    return;
  }

  const selectedRadius = Math.min(...usableRadii);
  let candidates = [];

  DATA.forEach(r => {
    if (r.radius !== selectedRadius) return;
    if (r.capacity < totalLoad) return;

    /* === GEOMETRY CHECK === */
    if (obsRadiusInput.value && obsHeightInput.value) {
      const obsR = +obsRadiusInput.value;
      const obsH = +obsHeightInput.value;
      const margin = +marginInput.value || 0;

      const horiz = r.boom * r.boom - selectedRadius * selectedRadius;
      if (horiz <= 0) return;

      const tipHeight = BOOM_FOOT_HEIGHT + Math.sqrt(horiz);
      const requiredHeight =
        (obsH * selectedRadius / obsR) + margin;

      if (tipHeight < requiredHeight) return;
    }

    candidates.push({
      boom: r.boom,
      config: r.config,
      capacity: r.capacity,
      util: totalLoad / r.capacity * 100
    });
  });

  if (!candidates.length) {
    result.innerHTML = `
      <p class="fail">
        No configuration clears capacity and/or obstruction constraints.
      </p>`;
    return;
  }

  candidates.sort((a,b)=>a.util-b.util);
  const best = candidates[0];

  if (best.util >= 90) {
    result.innerHTML = `
      <p class="fail">
        Lift not permitted – utilisation ${best.util.toFixed(1)}%.
      </p>`;
    return;
  }

  result.innerHTML = `
    <h3>Result</h3>
    <p><b>Total load:</b> ${totalLoad.toFixed(2)} t</p>
    <p><b>Configuration:</b> ${best.config}</p>
    <p><b>Boom:</b> ${best.boom} m</p>
    <p><b>Radius used:</b> ${selectedRadius.toFixed(1)} m</p>
    <p><b>Utilisation:</b>
      <span class="${utilClass(best.util)}">${best.util.toFixed(1)}%</span>
    </p>
  `;
}

[
  loadInput, riggingInput, radiusInput,
  obsRadiusInput, obsHeightInput, marginInput
].forEach(e => e.addEventListener("input", calculate));

ballast.addEventListener("change", () => loadData(ballast.value));

loadData(ballast.value);
</script>

</body>
</html>


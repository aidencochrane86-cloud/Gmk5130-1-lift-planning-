<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lift Planner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; padding:16px; }
.card { background:#fff; padding:16px; margin-bottom:16px; border-radius:8px; }
label { display:block; margin-top:10px; font-weight:bold; }
input, select { width:100%; padding:6px; margin-top:4px; }
input:disabled, select:disabled { background:#eee; color:#777; pointer-events:none; }
.meta { font-size:0.9em; background:#eef6ff; padding:8px; border-radius:6px; }

.output-meta {
  background:#f7f9ff;
  border:1px solid #ccd5ff;
  padding:8px;
  border-radius:6px;
  margin-bottom:10px;
  font-size:0.9em;
}

.util-green { color:#1a7f37; font-weight:bold; }
.util-amber { color:#b26a00; font-weight:bold; }
.util-red   { color:#b42318; font-weight:bold; }

.warn { background:#fff4e5; border:1px solid #ffcc80; padding:8px; border-radius:6px; margin-top:8px; }

table { width:100%; border-collapse:collapse; margin-top:12px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#f0f0f0; }
</style>
</head>

<body>

<div class="card meta">
  <strong>Crane:</strong> GMK5130-1<br>
  <span id="metaBallast"><strong>Ballast:</strong> —</span>
</div>

<div class="card">
<h2>Inputs</h2>

<label>Mode</label>
<select id="mode">
  <option value="optimised">Optimised</option>
  <option value="boom">Boom-specific</option>
</select>

<label>Ballast</label>
<select id="ballast">
  <option value="40_1t" data-code="2200">40.1 t (code 2200)</option>
  <option value="23_5t" data-code="1900">23.5 t (code 1900)</option>
  <option value="6t" data-code="1200">6 t (code 1200)</option>
</select>

<label>Requested boom (m)</label>
<input id="boomRequest" type="number">

<label>Select boom</label>
<select id="boomSelect"></select>

<label>Load (t)</label>
<input id="load" type="number">

<label>Radius (m)</label>
<input id="radius" type="number">

<label>Obstruction Radius (m)</label>
<input id="obsRadius" type="number">

<label>Obstruction Height (m)</label>
<input id="obsHeight" type="number">

<label>Clearance Margin (m)</label>
<input id="margin" type="number">
</div>

<div class="card">
<h2>Result</h2>
<div id="result">Select inputs.</div>
</div>

<script>
const BOOM_FOOT_HEIGHT = 2;
let DATA = {};
let ACTIVE = [];

const metaBallast = document.getElementById("metaBallast");
const ballast = document.getElementById("ballast");
const modeSel = document.getElementById("mode");
const boomReq = document.getElementById("boomRequest");
const boomSel = document.getElementById("boomSelect");
const loadIn = document.getElementById("load");
const radIn = document.getElementById("radius");
const obsR = document.getElementById("obsRadius");
const obsH = document.getElementById("obsHeight");
const marginIn = document.getElementById("margin");
const result = document.getElementById("result");

function utilClass(u){ return u>=90?"util-red":u>=85?"util-amber":"util-green"; }

async function loadAll() {
  const keys = ["40_1t","23_5t","6t"];
  for (let k of keys) {
    const r = await fetch(`loadchart_${k}.json`);
    const j = await r.json();
    DATA[k] = j.charts;
  }
  updateBoomOptions();
  calculate();
}

function updateBoomOptions(){
  boomSel.innerHTML="";
  if(!boomReq.value) return;
  const booms=[...new Set(ACTIVE.map(r=>r.boom))].sort((a,b)=>a-b);
  booms.forEach(b=>{
    if(Math.abs(b-boomReq.value)<=3){
      const o=document.createElement("option");
      o.value=b; o.textContent=`${b} m`;
      boomSel.appendChild(o);
    }
  });
}

function ballastCode(){
  return ballast.selectedOptions[0].dataset.code;
}

function calculate(){
  const mode=modeSel.value;
  ACTIVE = DATA[ballast.value] || [];

  metaBallast.innerHTML =
    `<strong>Ballast:</strong> ${ballast.options[ballast.selectedIndex].text}`;

  if(mode==="boom"){
    if(!boomSel.value){ result.innerHTML="Select boom."; return; }

    const rows = ACTIVE.filter(r=>r.boom==boomSel.value);
    let html = `<div class="output-meta">
      <strong>Boom:</strong> ${boomSel.value} m<br>
      <strong>Ballast code:</strong> ${ballastCode()}
    </div>`;

    html+=`<table><tr><th>Radius</th><th>Capacity</th></tr>`;
    rows.forEach(r=> html+=`<tr><td>${r.radius}</td><td>${r.capacity}</td></tr>`);
    html+=`</table>`;

    // ballast comparison
    if(DATA["40_1t"] && DATA["23_5t"]){
      const a = DATA["40_1t"].filter(r=>r.boom==boomSel.value);
      const b = DATA["23_5t"].filter(r=>r.boom==boomSel.value);
      let diffRadius = null;
      for(let i=0;i<a.length;i++){
        if(b[i] && a[i].capacity !== b[i].capacity){
          diffRadius = a[i].radius; break;
        }
      }
      html+=`<div class="warn">${
        diffRadius
          ? `Ballast effect begins at ≥ ${diffRadius} m radius`
          : `No ballast effect across this boom`
      }</div>`;

      html+=`<table><tr><th>Radius</th><th>23.5 t</th><th>40.1 t</th></tr>`;
      a.forEach(r=>{
        const m=b.find(x=>x.radius==r.radius);
        html+=`<tr><td>${r.radius}</td><td>${m?m.capacity:"-"}</td><td>${r.capacity}</td></tr>`;
      });
      html+=`</table>`;
    }

    result.innerHTML=html;
    return;
  }

  // OPTIMISED
  if(!loadIn.value||!radIn.value||!obsR.value||!obsH.value){
    result.innerHTML="Enter all required inputs."; return;
  }

  let best=null, alt=null;
  ACTIVE.forEach(r=>{
    if(r.radius<radIn.value||r.capacity<loadIn.value) return;
    const h=BOOM_FOOT_HEIGHT+Math.sqrt(r.boom*r.boom-radIn.value*radIn.value);
    const req=(obsH.value*radIn.value/obsR.value)+(+marginIn.value||0);
    if(h<req) return;
    const u=loadIn.value/r.capacity*100;
    if(!best||u<best.u){ alt=best; best={...r,u}; }
  });

  if(!best){ result.innerHTML="No valid configuration."; return; }

  let html=`<h3>Best configuration</h3>
    <p><b>Config:</b> ${best.config}</p>
    <p><b>Utilisation:</b> <span class="${utilClass(best.u)}">${best.u.toFixed(1)}%</span></p>`;

  // ballast effectiveness
  if(ballast.value==="40_1t"){
    const low=DATA["23_5t"].find(r=>r.boom==best.boom && r.radius>=radIn.value);
    if(low && low.capacity>=best.capacity){
      html+=`<div class="warn">40.1 t ballast offers no capacity benefit for this lift</div>`;
    }
  }

  result.innerHTML=html;
}

[ballast,modeSel,boomReq,boomSel,loadIn,radIn,obsR,obsH,marginIn]
  .forEach(e=>e.addEventListener("input",()=>{ updateBoomOptions(); calculate(); }));

loadAll();
</script>

</body>
</html>
